import openai
import gradio as gr
import time

def init_messages(system_content):
    return [
        {"role": "system", "content": system_content}
    ]

def append_assistant_message(messages, assistant_content):
    messages.append({"role": "assistant", "content": assistant_content})

def append_user_message(messages, user_content):
    messages.append({"role": "user", "content": user_content})
    
def get_response(messages):
    openai.api_key = "9caacd23ebca451593bf09eda10b006f"
    openai.api_base = "https://hkust.azure-api.net"
    openai.api_type = "azure"
    openai.api_version = "2023-05-15"
    
    response = openai.ChatCompletion.create(
        # engine="gpt-35-turbo-16k",
        engine="gpt-4-32k",
        messages=messages
    )
    
    return response.choices[0].message.content

if __name__ == "__main__":

    video_prompt = "close up photo of a rabbit, forest, haze, halation, bloom, dramatic atmosphere"

    system_content = f"""
    Now you are acting as a generator to generate a prompt for a text-to-music generation model (like audiocraft). 
    I want the music to be coherent and consistent with a video generated by a text-to-video model.
    The video prompt is: {video_prompt}, and the music prompt should be generated based on the content in the video prompt.
    
    Since the video prompt might not include sufficient information for music generation, you can ask me questions to know more about my preferences and requirements.
    Here are some suggested questions for you to ask, you need to use at least 3 of them:
    - Would you prefer a specific instrument for the music?
    - Do you have any particular mood or tempo you have in mind?
    - Do you have a particular instrument in mind, such as piano, violin, flute, or any other?
    - Are there any specific styles you'd like the music to be inspired by?
    - Are there any specific emotions or moods you want the music?
    - Would you prefer a steady tempo throughout, or are there specific tempo changes or rhythms you'd like to explore?
    - What kind of emotions do you want to express in the music?
    - What is the environmental condition of this music?
    For each question, you can try to propose a few answers for me to choose from, like this:
        Would you prefer a specific instrument for the music? like piano, violin, flute, or any other?
        What kind of emotions do you want to express in the music? like happiness, sadness, or any other?
    You can also ask me other questions if you think that's neccessary.
    If I clearly state that I don't have any preference for a specific question, you can skip that question.
    Please remember! You should only ask one question at a time.
    
    If you think you have enough information, you can start to generate the prompt.
    
    Here are some requirements for your output:
    1. The output should be a complete sentence, describing the style and the mood of the music, and also the musical instruments you want to use.
    2. You need to include at least one specific musical instruments (no more than three) 
    3. You need to include at least one specific style of music in your output.
    4. You need to include at least one specific mood or emotion in your output.
    5. Try not to include environmental sound.
    6. Do not include any information that is not related to music!!!
    7. The final output should be no more than two sentencens with at most 25 words (this is very important!!!).
    8. The output music would just be a short piece of music, so try to make the prompt simple.
    
    Here are some good music generation prompts for your reference:
    - a light and cheerly EDM track, with syncopated drums, aery pads, and strong emotions bpm: 130
    - lofi slow bpm electro chill with organic samples
    - A cheerful country song with acoustic guitars
    - An 80s driving pop song with heavy drums and synth pads in the background
    
    When you propose a prompt, please clearly state the prompt in a pair of double quotation marks, like this:
    - Here is my prompt: "a light and cheerly EDM track, with syncopated drums, aery pads, and strong emotions bpm: 130"
    
    Please remember! The final output should be no more than two sentencens with at most 25 words.
    """
    
    # build an interface using gradio
    with gr.Blocks() as demo:
        messages = init_messages(system_content)
        
        gr.Markdown(
        """
        # Dream-maker Demo for Video-generation
        Type to chat with our chatbot.
        """)
        
        greet_message = """
        Hi, this is Dream-maker.
        Now let's move on to create a backgound music for the video.
        """
        append_assistant_message(messages, greet_message)
        init_response = get_response(messages)
        append_assistant_message(messages, init_response)
        init_response = f"""{greet_message}
        Your video prompt is set to be: {video_prompt}
        {init_response}
        """
        
        chatbot = gr.Chatbot(show_copy_button=True, value=[[None, init_response]])
        msg = gr.Textbox()
        # clear = gr.ClearButton([msg, chatbot])

        def respond(message, chat_history):
            append_user_message(messages, message)
            bot_message = get_response(messages)
            chat_history.append((message, bot_message))
            return "", chat_history

        msg.submit(respond, [msg, chatbot], [msg, chatbot])
        
    demo.launch()
    